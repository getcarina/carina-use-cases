<!--
Outline:

 * Deconst: What & Why
   - developer.rackspace.com, support.rackspace.com, getcarina.com, docs.rackspace.com
   - Before: different processes, different people
   - What we didn't want: "We're using X now, everybody conform or be abandoned"
   - Unify: infrastructure; content; templates, CSS, JS; search; metrics; logging
   - Keep separate: GitHub repositories; documentation formats
 * Preview comments!
   - From very early: need to preview rendered content before it goes live
   - Make a pull request on a content repository
   - Bot account will post a link to a staging site
 * System components:
   - Content service: API for storing and retrieving "metadata envelopes" by content ID (a URI)
   - Presenter: URL -> content ID, get the envelope from the content service, render it with a template
   - Stateless containers behind a CLB; can scale horizontally as needed
 * "Staging mode"
   - Content service: Envelope not found? Cut first path segment, request from "upstream"
   - Presenter: Ignore first path segment for content and template mapping purposes
 * Strider
   - Opensource CI/CD server
   - Run a sequence of processes in Docker containers that mount a workspace DVC
   - Docker is important here: Sphinx's conf.py or Jekyll plugins are arbitrary code!
   - The "Preparer" runs Sphinx/Jekyll shimmed to output JSON files
   - The "Submitter":
     - queries the content API to see what's new
     - build tarballs of new assets and new envelopes
     - POST to the content API
   - If the submitter submitted something, derive the destination link and post it to the PR

-->

<section id="deconst-1">
  <h2><a href="https://developer.rackspace.com/">developer.rackspace.com</a></h2>
  <h2><a href="https://support.rackspace.com/">support.rackspace.com</a></h2>
  <h2><a href="https://getcarina.com/">getcarina.com</a></h2>

  <aside class="notes">
    <p>These domains are all served by a single, open-source system called "Deconst"</p>
    <p>Not static sites</p>
  </aside>
</section>

<section id="deconst-2">

  <h2>Deconst</h2>
  <h3>Deconstruct your documentation</h3>

  <img src="https://cloud.githubusercontent.com/assets/17565/15220153/7ef8e212-1834-11e6-928c-c7c24f156713.png" alt="deconst logo">

  <aside class="notes">
    <p>"Inverted CMS"</p>
    <p>Manage content with an API</p>
    <p>Bring together docs written in many places in many ways</p>
  </aside>
</section>

<section id="deconst-3">

  <h1>The dark ages</h1>

  <aside class="notes">
    <p>Each site managed independently by different processes</p>
    <p>Making changes = hunting down the right person and sending email</p>
    <p>Publishing = all over the place; some Jenkins, some manual</p>
  </aside>
</section>

<section id="deconst-4">

  <h2>What we didn't want</h2>

  <a href="https://xkcd.com/927/">
    <img src="https://cloud.githubusercontent.com/assets/17565/15220287/e4a53ade-1834-11e6-9e70-a6d08b9a4f09.png" alt="obligatory XKCD">
  </a>

  <aside class="notes">
    <p>"Hey everybody, spend loads of time converting all your docs into our one true format!"</p>
    <p>Or even worse: tooling</p>
  </aside>
</section>

<section id="deconst-5">

  <h2>Unify</h2>

  <section tagcloud large>
    <span tagcloud-weight="40">infrastructure </span>
    <span tagcloud-weight="10">storage </span>
    <span tagcloud-weight="40">templates </span>
    <span tagcloud-weight="20">CSS </span>
    <span tagcloud-weight="20">JS </span>
    <span tagcloud-weight="50">search </span>
    <span tagcloud-weight="30">metrics </span>
    <span tagcloud-weight="30">logging </span>
  </section>

  <aside class="notes">
    <p>Reasons to bring everything together</p>
  </aside>
</section>

<section id="deconst-6">

  <h2>Separate</h2>

  <section tagcloud large>
    <span tagcloud-weight="40">github repositories </span>
    <span tagcloud-weight="30">text editors </span>
    <span tagcloud-weight="50">documentation formats </span>
    <span tagcloud-weight="30">processes </span>
  </section>

  <aside class="notes">
    <p>Things we wanted to leave alone as much as possible</p>
    <p>Working in a monorepo made builds really slow and led to distracting cross-chatter in issues, etc</p>
    <p>Sphinx is better for multi-page docs with a TOC</p>
    <p>Jekyll is built for blogs</p>
    <p>Process: there is "process sugar" to encourage working on GitHub and deploy continuously</p>
  </aside>
</section>

<section id="deconst-7">

  <h2>Preview links</h2>

  <img src="https://cloud.githubusercontent.com/assets/17565/15221290/db62fb10-1838-11e6-814a-2208514cc1db.jpeg" alt="rackernexus">

  <aside class="notes">
    <p>Number one need from the day we shipped: ability to see content before it's live</p>
    <p>Needs to be accessible to a wide range of potential contributors</p>
    <p>Don't assume everyone has a good Ruby, Python, Node setup locally</p>
    <p>Vagrant/local Docker cause more yak-shaving problems</p>
    <p>No "staging server": complicated git workflows, only one person can use it at a time</p>
  </aside>
</section>

<section id="deconst-8" data-transition="none" >

  <h2>System Components</h2>

  <img src="https://cloud.githubusercontent.com/assets/17565/15224379/03679720-1847-11e6-87c4-2542a42242b8.png" alt="content service" class="borderless">

  <p>
    <code>
      https://github.com/org/repo/posts/my-post
    </code>
  </p>

  <aside class="notes">
    <p>Deconst consists of two processes (in Docker containers)</p>
    <p>Content service: CRUD API endpoints for content</p>
    <p>Stores and indexes incoming documents, addressed by a "content ID"</p>
    <p>For content IDs, we use URIs based on GitHub repo (but they really just have to be unique)</p>
  </aside>
</section>

<section id="deconst-9">

  <h2>System Components</h2>

  <img src="https://cloud.githubusercontent.com/assets/17565/15224382/063bf428-1847-11e6-93dd-c4cbd2fba0e8.png" alt="presenter" class="borderless">

  <p>
    <code>
      /posts/my-post/ ðŸ‘‰ https://github.com/org/repo/blog/my-post
    </code>
  </p>

  <aside class="notes">
    <p>Presenter: map host + path to a content ID, get content, render with template</p>
  </aside>
</section>

<section id="deconst-10">

  <h2>Staging mode</h2>

  <p>
    <code>
      /<span class="highlight">build-123567</span>/posts/my-post/
    </code>
  </p>

  <p>
    <code>
      https://github.com/<span class="highlight">build-123567</span>/org/repo/blog/my-post
    </code>
  </p>

  <aside class="notes">
    <p>In "staging mode", the first path component is treated as a "build environment"</p>
    <p>Presenter yanks it off before mapping to a content ID + template</p>
    <p>Content service checks for content locally</p>
    <p>Proxies the request to production without the build env if it isn't found</p>
    <p>
      The outcome: content submitted to staging with a build environment in its content ID is
      rendered "over" the current content in production; the rest of the site is "hoisted" beneath
      the build environment too
    </p>
  </aside>
</section>

<section id="deconst-11">

  <img src="https://camo.githubusercontent.com/4cd1630dc1f92b698b4d99a530a7f24a4eea744a/68747470733a2f2f7261772e6769746875622e636f6d2f537472696465722d43442f737472696465722f6d61737465722f7075626c69632f696d616765732f746f705f6769746875622e706e67" alt="strider logo">

  <aside class="notes">
    <p>How does it get there?</p>
    <p>Opensource CI/CD software called "Strider"</p>
    <p>Chosen because it's nice and twelve-factor, customizable</p>
  </aside>
</section>

<section id="deconst-12" data-transition="none">

  <h2>Preparer</h2>

  <img src="https://cloud.githubusercontent.com/assets/17565/15226195/b4b1b742-184f-11e6-80cf-bcb6e2cea27e.png" alt="preparer" class="borderless">

  <aside class="notes">
    <p>Custom Strider build plugin run two Docker containers in sequence</p>
    <p>First is the "preparer"</p>
    <p>An adapter between the host doc system and the JSON format the content service understands</p>
    <p>Writes assets and JSON documents to directories within a workspace volume</p>
    <p>Important to run in Docker, as a non-root user! Jekyll and Sphinx can both run arbitrary code</p>
    <p>Also keeps us from having to manage Ruby / Python / Node versions on the build host</p>
  </aside>
</section>

<section id="deconst-13" data-transition="none">

  <h2>Submitter</h2>

  <img src="https://cloud.githubusercontent.com/assets/17565/15226473/dae4f13a-1850-11e6-8ebe-92d5cde0e678.png" alt="submitter" class="borderless">

  <aside class="notes">
    <p>Query the content service with fingerprints to see which assets and documents are new</p>
    <p>Pack them in tarballs and bulk-upload them</p>
    <p>Strider watches the container's exit status</p>
  </aside>
</section>

<section id="deconst-14" data-transition="none">

  <h2>Fin</h2>

  <p><a href="https://deconst.horse/">deconst.horse</a></p>
  <p><a href="https://github.com/deconst/">github.com/deconst</a></p>

  <aside class="notes">
  </aside>
</section>
